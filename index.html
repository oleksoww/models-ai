<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ¤– Multi-AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 text-white p-6">
  <div class="max-w-4xl mx-auto space-y-4">
    <h1 class="text-3xl font-bold text-center">ğŸ¤– Multi-AI Chat</h1>

    <!-- Nowy / wybÃ³r czatu -->
    <div class="flex gap-2">
      <select id="chatSelector" class="flex-1 p-2 rounded bg-gray-700"></select>
      <button onclick="newChat()" class="px-4 py-2 bg-green-600 rounded">â• Nowy czat</button>
    </div>

    <!-- Model -->
    <select id="modelSelect" class="w-full p-2 rounded bg-gray-700"></select>

    <!-- API Key -->
    <div class="flex gap-2">
      <input id="apiKeyInput" type="password" class="flex-1 p-2 rounded bg-gray-700" placeholder="Wpisz klucz API"/>
      <button onclick="saveKey()" class="px-4 py-2 bg-blue-600 rounded">ğŸ’¾ Zapisz klucz</button>
    </div>

    <!-- Okno czatu -->
    <div id="chatWindow" class="h-96 overflow-y-auto bg-gray-900 p-4 rounded space-y-2"></div>

    <!-- Input -->
    <div class="flex gap-2">
      <input id="messageInput" class="flex-1 p-2 rounded bg-gray-700" placeholder="Napisz wiadomoÅ›Ä‡..."/>
      <button onclick="sendMessage()" class="px-4 py-2 bg-purple-600 rounded">ğŸ“© WyÅ›lij</button>
    </div>
  </div>

  <script>
    const MODELS = {
      "gpt-4": { label: "ChatGPT 4", apiUrl: "https://api.openai.com/v1/chat/completions", provider: "openai" },
      "gpt-3.5-turbo": { label: "ChatGPT 3.5", apiUrl: "https://api.openai.com/v1/chat/completions", provider: "openai" },
      "gemini-pro": { label: "Gemini Pro", apiUrl: "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent", provider: "google" },
      "claude-3": { label: "Claude 3", apiUrl: "https://api.anthropic.com/v1/messages", provider: "anthropic" },
      "llama-2": { label: "LLaMA 2", apiUrl: "https://api.llama.meta/v1/chat", provider: "meta" },
    };

    let chats = JSON.parse(localStorage.getItem("chats") || "[]");
    let currentChatId = null;

    const chatSelector = document.getElementById("chatSelector");
    const chatWindow = document.getElementById("chatWindow");
    const modelSelect = document.getElementById("modelSelect");
    const messageInput = document.getElementById("messageInput");
    const apiKeyInput = document.getElementById("apiKeyInput");

    // Inicjalizacja modelÃ³w
    for (let [key, m] of Object.entries(MODELS)) {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = m.label;
      modelSelect.appendChild(opt);
    }

    function renderChatList() {
      chatSelector.innerHTML = "";
      chats.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        chatSelector.appendChild(opt);
      });
      if (currentChatId) chatSelector.value = currentChatId;
    }

    function renderMessages() {
      chatWindow.innerHTML = "";
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;
      chat.messages.forEach(m => {
        const div = document.createElement("div");
        div.className = `p-2 rounded-lg max-w-[75%] whitespace-pre-wrap ${m.role==="user" ? "bg-blue-600 ml-auto" : (m.role==="assistant" ? "bg-gray-700" : "bg-yellow-700")}`;
        div.textContent = m.content;
        chatWindow.appendChild(div);
      });
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function saveChats() {
      localStorage.setItem("chats", JSON.stringify(chats));
    }

    function newChat() {
      const id = Date.now().toString();
      chats.push({ id, name: "Czat " + (chats.length+1), model: "gpt-4", messages: [] });
      currentChatId = id;
      saveChats();
      renderChatList();
      renderMessages();
    }

    chatSelector.addEventListener("change", () => {
      currentChatId = chatSelector.value;
      renderMessages();
    });

    function saveKey() {
      const model = modelSelect.value;
      localStorage.setItem("apiKey_" + MODELS[model].provider, apiKeyInput.value);
      alert("âœ… Klucz zapisany dla " + MODELS[model].label);
    }

    async function sendMessage() {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;

      const model = modelSelect.value;
      const { apiUrl, provider } = MODELS[model];
      const apiKey = localStorage.getItem("apiKey_" + provider);
      if (!apiKey) {
        alert("âŒ Podaj klucz API dla " + MODELS[model].label);
        return;
      }

      const input = messageInput.value.trim();
      if (!input) return;
      chat.messages.push({ role: "user", content: input });
      messageInput.value = "";
      renderMessages();

      try {
        let body;
        let headers = { "Content-Type": "application/json" };

        if (provider === "openai") {
          headers["Authorization"] = `Bearer ${apiKey}`;
          body = JSON.stringify({ model, messages: chat.messages });
        } else if (provider === "google") {
          body = JSON.stringify({ contents: [{ parts: [{ text: input }] }] });
        } else if (provider === "anthropic") {
          headers["x-api-key"] = apiKey;
          body = JSON.stringify({
            model: model,
            max_tokens: 512,
            messages: chat.messages.map(m => ({ role: m.role, content: m.content }))
          });
        } else if (provider === "meta") {
          headers["Authorization"] = `Bearer ${apiKey}`;
          body = JSON.stringify({ messages: chat.messages });
        }

        const res = await fetch(provider === "google" ? `${apiUrl}?key=${apiKey}` : apiUrl, {
          method: "POST", headers, body
        });

        const data = await res.json();
        console.log("ğŸ” OdpowiedÅº API:", data);

        // Debug message w czacie
        chat.messages.push({ role: "system", content: "ğŸ“¦ DEBUG: " + JSON.stringify(data, null, 2) });

        let reply = "(Brak odpowiedzi)";
        if (provider === "openai") {
          reply = data.choices?.[0]?.message?.content || data.choices?.[0]?.text || reply;
        } else if (provider === "google") {
          reply = data.candidates?.[0]?.content?.parts?.[0]?.text || data.candidates?.[0]?.output || reply;
        } else if (provider === "anthropic") {
          reply = data.content?.[0]?.text || data.output_text || reply;
        } else if (provider === "meta") {
          reply = data.choices?.[0]?.message?.content || data.choices?.[0]?.text || reply;
        }

        chat.messages.push({ role: "assistant", content: reply });
        saveChats();
        renderMessages();
      } catch (err) {
        console.error(err);
        chat.messages.push({ role: "system", content: "âš ï¸ BÅ‚Ä…d poÅ‚Ä…czenia z API" });
        renderMessages();
      }
    }

    // Start
    if (chats.length === 0) newChat();
    else {
      currentChatId = chats[0].id;
      renderChatList();
      renderMessages();
    }
  </script>
</body>
</html>
